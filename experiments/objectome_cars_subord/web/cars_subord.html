<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Object Identification</title>

<style>
body { margin:0; padding: 0; font-family: 'trebuchet ms', trebuchet, verdana }
div,pre { margin:0; padding:0 }
h2 { margin: 20px 0 5px 0; padding: 0 }
p.intro { margin: 0; padding: 15px; background: #eee; font-size: small; }
.thumbs { position: absolute; width: 100px; height: 100px;}
div.thumb { position:absolute; float:left; padding: 1px; width: 64px; height: 64px;}
div.thumb img { border: 2px solid white; width:64px; height:64px; }

div#tutorial {
position:relative;
background-color: white;
padding: 10px;
}

.shrinkwidth {
width:360px;
height:auto;
}

.shrinkheight {
width:auto;
height:360px;
}

</style>


<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.8.0.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://dicarlo-lab.scripts.mit.edu/srv/ip.php"></script>
<script type="text/javascript" src="https://s3.amazonaws.com/dlcommon/js/browserdetect-0.0.1.js"></script>
<script type="text/javascript" src="https://s3.amazonaws.com/dlcommon/js/zen-0.0.2.js"></script>
<script type="text/javascript" src="https://s3.amazonaws.com/dlcommon/js/detect-zoom-20120627.js"></script>
<script type="text/javascript" src="https://s3.amazonaws.com/dlcommon/js/dltk-20140821-6617f17.js"></script>

<script type="text/javascript">
ExperimentData = null;
var num_correct = 0;
var reward;
var acc;


//!!==BEGIN DYNAMIC TRIAL CODE==!!//
function beginExp() {
    begin = true;
    $("#begintask").hide();
    $("#begintaskdiv").hide();
    $("#_preload").hide();
    preTrial(false);
}

function preTrial(drawn) {
    $('#group_container').hide();
    $('.fixation img').attr('src', fixationImage.src);
    $('.fixation').show();
    window.scrollTo(0, 0); // forced sync

    /*  hahong: for safer canvas use, disable this
    //Set proper height/width
    if (getAspectRatio(tmpImage) > 1) {
        //width is longer axis
        $('#main_test').removeClass().addClass('shrinkwidth');
    } else {
        //height is longer axis
        $('#main_test').removeClass().addClass('shrinkheight');
    } */

    setTimeout(function() {
        // fixation dot has appeared
        var t_bias;
        t_pre_stimon = performance.now();

        t_bias = dltk.getDriftCompensation(measuredISI1, delayBiasISI1, ISI);
        dltk.setTimeout2(showStim, ISI - js_tres - t_bias);  // subtract js_tres because of setTimeout(fn, 0)

        delayBiasISI1.push(t_bias);
        if (!drawn) dltk.drawToContext(imgFiles[trialNumber][0], ctx_test_off, null, false);
    }, 0);
}

function showStim() {
    dltk.copyContexts(ctx_test_off, ctx_test_on);
    $('.test').show();
    $('.fixation').hide();
    t_stim_queued = performance.now();

    setTimeout(function() {
        // at this point, the stimulus has been painted completely
        var t_bias;
        t_at_stimon = performance.now();

        t_bias = dltk.getDriftCompensation(measuredStimdur, delayBiasStimdur, stimduration);
        t_stimon_lag = t_at_stimon - t_stim_queued;
        dltk.setTimeout2(function() {
            $('.test').hide();
            t_stim_dequeued = performance.now();

            setTimeout(function() {
                // here, the stimulus has been erased completely
                var t_bias;
                t_at_stimoff = performance.now();

                t_bias = dltk.getDriftCompensation(measuredISI2, delayBiasISI2, ISI);
                t_stimoff_lag = t_at_stimoff - t_stim_dequeued;
                dltk.setTimeout2(showResponse, ISI - js_tres - t_bias);  // subtract js_tres because of setTimeout(fn, 0)
                delayBiasISI2.push(t_bias);
                measuredStimoffLag.push(t_stimoff_lag);

                t_stimondur = t_at_stimoff - t_at_stimon;
                measuredStimdur.push(t_stimondur);
                console.log('stim dur = ' + t_stimondur);

                // pre-draw images: should take less than ISI
                dltk.drawToContext(imgFiles[trialNumber][1][0], ctx_resp1_off, null, false);
                dltk.drawToContext(imgFiles[trialNumber][1][1], ctx_resp2_off, null, false);
            }, 0);
        }, stimduration - js_tres - t_bias);  // subtract js_tres because of setTimeout(fn, 0)
        delayBiasStimdur.push(t_bias);
        measuredStimonLag.push(t_stimon_lag);

        t_ISI1 = t_at_stimon - t_pre_stimon;
        measuredISI1.push(t_ISI1);
        console.log('ISI1 = ' + t_ISI1);
    }, 0);
}

function getAspectRatio(im) {
    //Defining aspect ratio as width/height
    var width = im.naturalWidth;
    var height = im.naturalHeight;
    var ar = width / height;
    return ar;
}

function showResponse() {
    /* hahong: simplify
    $('#label1').html(labels[trialNumber][0]);
    $('#label2').html(labels[trialNumber][1]);
    $('#totalSeen').html('Total Objects Seen: 0');
    */
    /* hahong: reward related
    acc = parseFloat(num_correct) / Math.max(1,trialNumber);
    format_acc = (acc * 100).toPrecision(3);
    reward = reward_scale[trialNumber][Math.floor(acc*99)].toPrecision(2); */

    // these should take short
    dltk.copyContexts(ctx_resp1_off, ctx_resp1_on);
    dltk.copyContexts(ctx_resp2_off, ctx_resp2_on);

    $('#trialCounter').html('Progress:<br /> ' + trialNumber + ' of ' +
        totalTrials);
    $('#group_container').show();
    setTimeout(function() {
        // now response images are up
        t_after_stimoff = performance.now();
        trialStartTime = new Date();

        t_ISI2 = t_after_stimoff - t_at_stimoff;
        measuredISI2.push(t_ISI2);
        console.log('ISI2 = ' + t_ISI2);

        if (trialNumber + 1 < totalTrials)
            dltk.drawToContext(imgFiles[trialNumber + 1][0], ctx_test_off, null, false);
    }, 0);
}

function clicked(myval, index) {
    if (!begin) return;
    trialEndTime = new Date();
    /* hahong: reward related
    var meta_correct = imgData[trialNumber]["Sample"][ExperimentData.meta_field[trialNumber]];
    var meta_response = imgData[trialNumber]["Test"][index][ExperimentData.meta_field[trialNumber]];
    console.log(index);
    console.log(meta_correct);
    console.log(meta_response);
    if(meta_correct == meta_response){
        num_correct++;
    } */
    pushData(myval);
    endTrial();
}

function pushData(myval) {
    StimDone.push(imgFiles[trialNumber]);
    response.push(myval);
    trialDurations.push(trialEndTime - trialStartTime);
}

function endTrial() {
    if (trialNumber >= (totalTrials - 1)) {
        var resultsobj = [];
        resultsobj.push({
            Response: response,
            ImgOrder: imgFiles,
            StimShown: StimDone,
            StimDuration: stimduration,
            RT: trialDurations,
            Condition: exp_type,
            Zoom: zoom,
            IPaddress: user_IP,
            Browser: BrowserDetect.browser,
            Version: BrowserDetect.version,
            OpSys: BrowserDetect.OS,
            WindowHeight: winH,
            WindowWidth: winW,
            ScreenHeight: vertical,
            ScreenWidth: horizontal,
            measISI1: measuredISI1,
            measISI2: measuredISI2,
            measStimdur: measuredStimdur,
            measStimonLag: measuredStimonLag,
            measStimoffLag: measuredStimoffLag,
            biasISI1: delayBiasISI1,
            biasISI2: delayBiasISI2,
            biasStimdur: delayBiasStimdur,
            bogoMIPS: avg_mips,
            ImgData: imgData,
            /* hahong: reward related
                Performance:acc,
                Bonus:reward */
        });
        document.getElementById("assignmentId").value = aID;
        document.getElementById("data").value = JSON.stringify(resultsobj);
        document.getElementById("postdata").submit();
    } else if (jQuery.inArray(trialNumber, BreakTimes) > -1) {
        takeABreak();
    } else {
        trialNumber++;
        preTrial(true);
    }
}

function takeABreak() {
        drawToContext(breakscreen.src, ctx_test_on, null, false);
        $('.fixation').hide();
        $('.test').show();
        $('#_preload').html(
            "<font color=red style=background-color:white>You have completed " +
            Math.round((trialNumber / totalTrials) * 100) +
            "% of the experiment. Be sure to pay attention so that you know you can finish on time!"
        );
        $('#_preload').show();
        document.onkeypress = function(e) {
            var evtobj = window.event ? event : e;
            var unicode = evtobj.charCode ? evtobj.charCode : evtobj.keyCode;
            var actualKey = String.fromCharCode(unicode);
            if (actualKey == 'z') {
                trialNumber++;
                $('.test').hide();
                $('#_preload').hide();
                preTrial(false);
            }
        };
    }
//!!==END DYNAMIC TRIAL CODE==!!//

function initVars() {
    var ctxs;
    zoom = DetectZoom.zoom();
    aID = dltk.getURLParameter("assignmentId");
    response = [];
    trialDurations = [];
    trialStartTime = new Date();
    measuredISI1 = [];
    measuredISI2 = [];
    measuredStimdur = [];
    measuredStimonLag = [];
    measuredStimoffLag = [];
    delayBiasISI1 = [];
    delayBiasISI2 = [];
    delayBiasStimdur = [];
    StimDone = [];
    imgFiles = [];
    fixationImage = new Image();
    fixationImage.src = "https://s3.amazonaws.com/task_images/fixation.png";
    breakscreen = new Image();
    breakscreen.src = "https://s3.amazonaws.com/task_images/break.png";
    stimduration = 100;
    // hahong: simplyfy: labels = ExperimentData.labels;
    ISI = 500;
    trialNumber = 0;
    totalTrials = ExperimentData.imgFiles.length;
    BreakTimes = [];
    begin = false;
    startpoint = 0;
    exp_type = 'two_way';
    imgData = ExperimentData.imgData;

    // double buffering. from: http://blog.bob.sh/2012/12/double-buffering-with-html-5-canvas.html
    ctxs = dltk.getContextsFromCanvas('main_test');
    ctx_test_on = ctxs.onscr;
    ctx_test_off = ctxs.offscr;

    ctxs = dltk.getContextsFromCanvas('img4');
    ctx_resp1_on = ctxs.onscr;
    ctx_resp1_off = ctxs.offscr;

    ctxs = dltk.getContextsFromCanvas('img5');
    ctx_resp2_on = ctxs.onscr;
    ctx_resp2_off = ctxs.offscr;

    /* hahong: reward related
    reward = 0;
    reward_scale = ExperimentData.reward_scale;*/
}

function preloadResources() {
    imgFiles = ExperimentData.imgFiles;
    //imgFiles = imgFiles.slice(startpoint*totalTrials,(startpoint+1)*totalTrials)
    //shuffle(imgFiles);
    /* stimFiles = imgFiles.map(function(a) {
        return a[0];
    }); */
    // hahong: this loads response images as well:
    stimFiles = imgFiles.flatten().getUnique();
}

function preBeginTask(res, res_var) {
    var nook = false;
    var details;
    js_tres = res;
    js_tres_variance = res_var;

    if (js_tres > dltk.JS_TRES_TOL) {
        details = "Your system is too slow to complete this task.";
        nook = true;
    }
    else if (js_tres_variance > dltk.JS_TRES_VAR_TOL) {
        details = "Your system's clock varies too much.";
        nook = true;
    }

    if (nook) {
        $('#_preload').hide();
        $('#warning').show();
        $('#warning').html(
            "<font color=red style=background-color:white><b>Your system CANNOT run this HIT at this point.  Close other programs and try again please.</b></font>"
        );
        alert(details + "  Close other programs and try again please.");
    }
    else {
        dltk.measureBogoMIPS(function(bogoMIPS) {
            avg_mips = bogoMIPS;
            $('#_preload').html("<font color=red style=background-color:white><b>Ready</b></font>");
            $("#begintaskdiv").css('visibility', 'visible');
            $("#begintask").click(beginExp);
        });
    }
}

$(document).ready(function() {
    $('#tutorial_original').hide();
    $('#tutorial2').hide();
    $('#tutorial3').hide();
    $('.test').hide();
    $('.fixation').hide();
    $('#group_container').hide();
    initVars();
    preloadResources();
    preload(stimFiles, function() {
        $('#_preload').html(
            "<font color=red style=background-color:white><b>Wait...</b></font>"
        );
        dltk.measureTimeResolution(preBeginTask);
    });
    $('.fixation img').attr('src', fixationImage.src);
    $('#warning').hide();
    $("#tutorial").html($("#tutorial_original").html());
    $("#tutorial").dialog({
        height: 500,
        width: 900,
        position: ['middle', 20],
        title: "Instructions"
    });
    if (aID == "ASSIGNMENT_ID_NOT_AVAILABLE") {
        $('#warning').show();
        $('#warning').html(
            "<font color=red style=background-color:white><b>You are in PREVIEW mode. Please ACCEPT this HIT to complete the task and receive payment.</b></font>"
        );
    }
    if (BrowserDetect.browser == 'Explorer') {
        $('#warning').show();
        $('#warning').append(
            "<span><font color=red style=background-color:white><b>Please only use the latest version of Chrome or Firefox for this HIT. Thank you!</b></font></span>"
        );
    }
});
</script>

</head>

<body bgcolor="#7F7F7F">
<div style="height:90%; width:95%; position:absolute;">
<div align="center" id="warning"></div>
<div id="begintaskdiv" style="position:absolute; top:40px; left: 47%; visibility: hidden;"><button id="begintask" value="Begin!" style="height:30px; width:70px;" >Begin!</button></div>
<div id="_preload" align="center" style="position:fixed; top:0px; left:10px;"></div>
<div class="fixation" align="center" style="position:relative; z-index:201; top:50%; height:256px; margin-top:-128px;"><img id="fixation_dot" src="" /></div>
<div class="test" align="center" style="position:relative; z-index:200; top:50%; height:360px; margin-top:-180px;">
<!-- img id="main_test" src="" style="position:relative; top:0px; left:0px; z-index:200;"/ -->
<canvas id="main_test" width="360" height="360" style="position:relative; top:0px; left:0px; z-index:200;"></canvas>
</div>
<div id="group_container"  style="position:relative; width:100%; top:50%; height:200px; margin-top:-100px;" align="center">
<table width="900" cellpadding="0" cellspacing="0" border="0" align="center" style="visibility:visible" id="responsetable">
  <tr>
    <td align="center">
    </td>
    <td align="center">
   </td>
    <td align="center">
    </td>
  </tr>
  <tr>
    <td align="center"><canvas id="img4" style="position:relative; top:0px; border:1px solid #000000;" height=200 width=200 src ="" onclick="clicked($(this).attr('src'), 0)"></canvas>
    </td>
    <td width="100" height="100" align="left" style="vertical-align:center;">
    <center style="margin-top:15px; position:relative; top:-30px;">
    <div id="trialCounter"></div>
    </center>
    </td>
    <td align="center"><canvas id="img5" style="position:relative; top:0px; border:1px solid #000000;" height=200 width=200 src ="" onclick="clicked($(this).attr('src'), 1)"></canvas>
    </td>
  </tr>
  <tr height=100>
    <td id="label1" align="center" width=200>
    </td>
    <td align="center">
    </td>
    <td id="label2" align="center" width=200>
    </td>
  </tr>
</table>
</div>

<div id="tutorial_link" style="position:fixed; top:0px; right:10px;" onclick="$('#tutorial').html($('#tutorial_original').html()); $('#tutorial').dialog({height:500,width:900,position:['middle', 20],title:'Instructions'})"><u>View Instructions</u></div>

<div id="tutorial" style="position:relative; z-index:-1"></div>
<div id="tutorial_original" style="position:absolute; z-index:-1;"><b> ***NOTE: Instructions have changed, and low performance will lead to rejection: make sure to read!**</b>
<p>Thank you for your interest! You are contributing to ongoing vision research at the Massachusetts Institute of Technology McGovern Institute for Brain Research.</p>
<p><font color=red><b>This task will require you to look at images on your computer screen and click to indicate a response for up to about 15 minutes, although we expect this to take about 5-10 minutes. If you cannot meet these requirements for any reason, or if doing so could cause discomfort or injury to you, do not accept this HIT.</b></font></p>
<p><font color=red><b>We encourage you to try a little bit of this  HIT before accepting to ensure it is compatible with your system. If you think the task is working improperly, your computer may be incompatible.</b></font></p>
<p>We recommend this task for those who are interested in contributing to scientific endeavors. Your answers will help MIT researchers better understand how the brain processes visual information.</p>
<center><p onclick="$('#tutorial').html($('#tutorial2').html())"><font color=blue><u>Click here to continue reading</u></font></p></center></div>
<div id="tutorial2" style="position:absolute; z-index:-1;">
<ul>
<li>You will see a series of images, each one presented for a very brief time. Each image will feature a single object from 60 possibilities. The objects are common things you might see around your house, on TV, in books, or on the Internet.
<p>
<li>After you see an image, <b>you must click the picture button which <u>exactly</u> matches the object you saw.</b> Once you click, you will move on to the next image immediately, so be ready.
<p>
<li>For example, if you think you saw a picture of a car, click the car picture to record your answer. There is <b>always</b> an exact match, and <b>SOMETIMES YOU MUST CHOOSE BETWEEN TWO OBJECTS OF THE SAME CATEGORY</b>. In other words, you might see two cars of different makes, and only one is correct.</li>
<p>
<li>Even if you're not 100% sure of what you saw, <u><b>make your best guess.</b></u></li>
<p>
<li>When you have worked though all the images, this HIT <b>will submit itself automatically</b>.</li>
</ul>
<center><p onclick="$('#tutorial').html($('#tutorial3').html())"><font color=blue><u>Click here to continue reading</u></font></p></center>
</div>
<div id="tutorial3" style="position:absolute; z-index:-1;">
<ul>
<p>
<li>Please be sure to maximize your browser window before beginning this experiment. .</li>
<p>
<li><b>In total, you will see 174 images. We expect this experiment to take about 5-10 minutes.</b> Note that the HIT will expire if you spend more than 25 minutes, so plan your time accordingly.</li>
<p>
<li>When you are ready to begin, click the "Begin" button at the very top of the screen. <b>Be prepared to see the first image -- it happens very fast!</b></li>
<p>
<li>If you have questions or concerns about this HIT, feel free to contact the requester. You can re-read these instructions at any time by clicking the link in the upper right-hand corner of the screen. Good luck!</li>
</ul>
<center><font color=blue><u><p onclick="$('#tutorial').dialog('close')">Click here to close the instructions</p></u></font></center>
</div>

</div>
<form style="visibility:hidden" id="postdata" action="https://www.mturk.com/mturk/externalSubmit" method="post">
  <input type="text" name="data" id="data" value="">
  <input type="text" name="assignmentId" id="assignmentId" value="">
</form>
</body>
</html>
